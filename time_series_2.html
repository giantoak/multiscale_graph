<!DOCTYPE html>
<meta charset="utf-8">
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap-theme.min.css">
    <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
    <style>
        
        body {
            font: 10px sans-serif;
        }
        
        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
        
        /*
         .x.axis path {
         display: none;
         }
         */
        
        .line {
            stroke: black;
            fill: none;
            stroke-width: 0.75px;
        }
        
        .line.line0 {
            stroke: steelblue;
           
        }
        
        .line.line1 {
            stroke: indianred;
            
        }
        
        .overlay {
            fill: none;
            pointer-events: all;
        }
        
        .focus circle {
            fill: none;
        }
        
        .focus circle.y0 {
            stroke: blue;
            fill : blue;
            
        }
        
        .focus circle.y1 {
            stroke: red;
            fill: red;
        }
        
        .focus line {
            stroke: purple;
            shape-rendering: crispEdges;
        }
        
        .focus line.y0 {
            stroke: steelblue;
            stroke-dasharray: 3 3;
            opacity: .5;
        }
        
        .focus line.y1 {
            stroke: indianred;
            stroke-dasharray: 3 3;
            opacity: .5;
        }
        
        .brush .extent {
            stroke: #fff;
            fill-opacity: .125;
            shape-rendering: crispEdges;
        }
        
        /*#container2 .node {
            stroke: #fff;
            stroke-width: 1.5px;
        }*/
        
       #container2 .node:not(:hover) .nodetext {
            display: none;
        }
        
  
        
        #container2 .link {
            stroke: #999;
            stroke-opacity: .6;
        }
        
        #container2 text {
            font: 10px sans-serif;
            pointer-events: none;
        }
        
        .legend {
            padding: 5px;
            font: 10px sans-serif;
            background: yellow;
            box-shadow: 2px 2px 1px #888;
        }
        
        p a.btn {
            position: relative;
            bottom:5px;
        }
        
  
        
        </style>
    <body>
        <div id="container" style="width:700px;border: 0px solid; float: left">
            <select class="form-control" id="stats_select">
                <option value="one">Scan statistics</option>
                <option value="two">Modularity</option>
                <option value="three">Graph Compression</option>
                <option value="four">Connected Components</option>
                <option value="five">Density</option>
        </select></div>
        <div id="container2" style="border: 0px solid; margin-left: 710px;height: 450px;" ></div>
        <div id="nav" margin-left:710px float:"bottom">
        <center>
         <button type="button" class="btn btn-default" id="left"><span class="glyphicon glyphicon-chevron-left"></span></button>
         <button type="button" class="btn btn-default" id="right"><span class="glyphicon glyphicon-chevron-right"></span></button>
            <br>
        <div class="checkbox">
                <label>
                    <input type="checkbox">Eigenvector centrality
                </label>
        </div>
        </center>
        </div>
        
        <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
        <script>
            
            window.id_them=0;
            window.week=0;
            window.id_us=0;
            
            //checks the drop-down menu for statistic
            
            
            $('#stats_select').click(function(e) {
                                var stats = $('#stats_select').val();
                                     d3.select("svg").remove(); 
                                     load_stats(stats);
                                e.preventDefault();// prevent the default anchor functionality
                                });
            
            var stats=$('#stats_select').val();
            
            function load_stats(stats){
                
                
            
            var main_margin = {top: 20, right: 80, bottom: 100, left: 40},
            mini_margin = {top: 430, right: 80, bottom: 20, left: 40},
            main_width = 800 - main_margin.left - main_margin.right,
            main_height = 500 - main_margin.top - main_margin.bottom,
            mini_height = 500 - mini_margin.top - mini_margin.bottom;
            
            var formatDate = d3.time.format("%H:%M"),
            parseDate = formatDate.parse,
            bisectDate = d3.bisector(function(d) { return d.Uhrzeit; }).left,
            formatOutput0 = function(d) { return formatDate(d.Uhrzeit) + " - " + d.Durchschn + " ms"; },
            formatOutput1 = function(d) { return formatDate(d.Uhrzeit) + " - " + d.Anz; };
            
            var main_x = d3.scale.linear()
            .range([0, main_width]),
            mini_x = d3.time.scale()
            .range([0, main_width]);
            
            var main_y0 = d3.scale.sqrt()
            .range([main_height, 0]),
            main_y1 = d3.scale.sqrt()
            .range([main_height, 0]),
            mini_y0 = d3.scale.sqrt()
            .range([mini_height, 0]),
            mini_y1 = d3.scale.sqrt()
            .range([mini_height, 0]);
            
            var main_xAxis = d3.svg.axis()
            .scale(main_x)
            //.tickFormat(d3.time.format("%H:%M"))
            .orient("bottom"),
            mini_xAxis = d3.svg.axis()
            .scale(mini_x)
            //.tickFormat(d3.time.format("%H:%M"))
            .orient("bottom");
            
            var main_yAxisLeft = d3.svg.axis()
            .scale(main_y0)
            .orient("left");
            main_yAxisRight = d3.svg.axis()
            .scale(main_y1)
            .orient("right");
            
            var brush = d3.svg.brush()
            .x(mini_x)
            .on("brush", brush);
            
            var main_line0 = d3.svg.line()
            .interpolate("monotone")
            .x(function(d) { return main_x(d.Uhrzeit); })
            .y(function(d) { return main_y0(d.Durchschn); });
            
            var main_line1 = d3.svg.line()
            .interpolate("monotone")
            .x(function(d) { return main_x(d.Uhrzeit); })
            .y(function(d) { return main_y1(d.Anz); });
            
            var mini_line0 = d3.svg.line()
            .x(function(d) { return mini_x(d.Uhrzeit); })
            .y(function(d) { return mini_y0(d.Durchschn); });
            
            var mini_line1 = d3.svg.line()
            .x(function(d) { return mini_x(d.Uhrzeit); })
            .y(function(d) { return mini_y1(d.Anz); });
            
            var svg = d3.select("#container").append("svg")
            .attr("width", main_width + main_margin.left + main_margin.right)
            .attr("height", main_height + main_margin.top + main_margin.bottom);
            
            svg.append("defs").append("clipPath")
            .attr("id", "clip")
            .append("rect")
            .attr("width", main_width)
            .attr("height", main_height);
            
            var main = svg.append("g")
            .attr("transform", "translate(" + main_margin.left + "," + main_margin.top + ")");
            
            var mini = svg.append("g")
            .attr("transform", "translate(" + mini_margin.left + "," + mini_margin.top + ")");
            
            d3.json("ss_dump", function(error, data) {
                   var stats=$('#stats_select').val();
                   data.forEach(function(d) {

                                if (stats=='four'){
                                d.Uhrzeit = d.x;
                                d.Durchschn = d.cc;
                                //d.Anz = d.them;
                                }
                                else if (stats=='five'){
                                d.Uhrzeit = d.x;
                                d.Durchschn = d.density.toFixed(6);
                                
                                }
                                else {
                                d.Uhrzeit = d.x;
                                d.Durchschn = d.us
                                d.Anz = d.them;
                                
                                }
                                });
                   
                   data.sort(function(a, b) {
                             return a.Uhrzeit - b.Uhrzeit;
                             });
                  
                   
                   main_x.domain([data[0].Uhrzeit, data[data.length - 1].Uhrzeit]);
                   main_y0.domain(d3.extent(data, function(d) { return d.Durchschn; }));
                   //main_y0.domain([0.1, d3.max(data, function(d) { return d.Durchschn; })]);
                   main_y1.domain(d3.extent(data, function(d) { return d.Anz; }));
                   mini_x.domain(main_x.domain());
                   mini_y0.domain(main_y0.domain());
                   mini_y1.domain(main_y1.domain());
                   
                   main.append("path")
                   .datum(data)
                   .attr("clip-path", "url(#clip)")
                   .attr("class", "line line0")
                   .attr("d", main_line0);
                   
                   main.append("path")
                   .datum(data)
                   .attr("clip-path", "url(#clip)")
                   .attr("class", "line line1")
                   .attr("d", main_line1);
                   
                   main.append("g")
                   .attr("class", "x axis")
                   .attr("transform", "translate(0," + main_height + ")")
                   .call(main_xAxis);
                   
                   main.append("g")
                   .attr("class", "y axis axisLeft")
                   .call(main_yAxisLeft)
                   .append("text")
                   .attr("transform", "rotate(-90)")
                   .attr("y", 6)
                   .attr("dy", ".71em")
                    .style("text-anchor", "end");
                   
                   
                   /*main.append("g")
                   .attr("class", "y axis axisRight")
                   .attr("transform", "translate(" + main_width + ", 0)")
                   .call(main_yAxisRight)
                   .append("text")
                   .attr("transform", "rotate(-90)")
                   .attr("y", -12)
                   .attr("dy", ".71em")
                   .style("text-anchor", "end")
                   .text("them");
                   */
                    
                   mini.append("g")
                   .attr("class", "x axis")
                   .attr("transform", "translate(0," + mini_height + ")")
                   .call(main_xAxis);
                   
                   mini.append("path")
                   .datum(data)
                   .attr("class", "line")
                   .attr("d", mini_line0);
                   
                   mini.append("path")
                   .datum(data)
                   .attr("class", "line")
                   .attr("d", mini_line1);
                   
                   mini.append("g")
                   .attr("class", "x brush")
                   .call(brush)
                   .selectAll("rect")
                   .attr("y", -6)
                   .attr("height", mini_height + 7);
                    
                   
                   var focus = main.append("g")
                   .attr("class", "focus")
                   .style("display", "none");
                   
                   // Anzeige auf der Zeitleiste
                   focus.append("line")
                   .attr("class", "x")
                   .attr("y1", main_y0(0) - 6)
                   .attr("y2", main_y0(0) + 6)
                   
                   // Anzeige auf der linken Leiste
                   focus.append("line")
                   .attr("class", "y0")
                   .attr("x1", main_width - 6) // nach links
                   .attr("x2", main_width + 6); // nach rechts
                   
                   // Anzeige auf der rechten Leiste
                   focus.append("line")
                   .attr("class", "y1")
                   .attr("x1", main_width - 6)
                   .attr("x2", main_width + 6);
                   
                   focus.append("circle")
                   .attr("class", "y0")
                    .attr("r", 4);
                   
                   focus.append("text")
                   .attr("class", "y0")
                   .attr("dy", "-1em");
                   
                   focus.append("circle")
                   .attr("class", "y1")
                   .attr("r", 4);
                   
                   focus.append("text")
                   .attr("class", "y1")
                   .attr("dy", "-1em");
                   
                   main.append("rect")
                   .attr("class", "overlay")
                   .attr("width", main_width)
                   .attr("height", main_height)
                   .on("mouseover", function() { focus.style("display", null); })
                   .on("mouseout", function() { focus.style("display", "none"); })
                   .on("mousemove", mousemove)
                   .on("click",mouseclicker);
                   
                   function mousemove() {
                   var x0 = main_x.invert(d3.mouse(this)[0]),
                   i = bisectDate(data, x0, 1),
                   d0 = data[i - 1],
                   d1 = data[i],
                   d = x0 - d0.Uhrzeit > d1.Uhrzeit - x0 ? d1 : d0;
                   focus.select("circle.y0").attr("transform", "translate(" + main_x(d.Uhrzeit) + "," + main_y0(d.Durchschn) + ")");
                   focus.select("text.y0").attr("transform", "translate(" + main_x(d.Uhrzeit) + "," + main_y0(d.Durchschn) + ")").text(d.Durchschn);
                   focus.select("circle.y1").attr("transform", "translate(" + main_x(d.Uhrzeit) + "," + main_y1(d.Anz) + ")");
                   focus.select("text.y1").attr("transform", "translate(" + main_x(d.Uhrzeit) + "," + main_y1(d.Anz) + ")").text(d.Anz);
                   //focus.select(".x").attr("transform", "translate(" + main_x(d.Uhrzeit) + ",0)");
                   focus.select(".y0").attr("transform", "translate(" + main_width*-1 + ", " + main_y0(d.Durchschn) + ")").attr("x2", main_width + main_x(d.Uhrzeit));
                   focus.select(".y1").attr("transform", "translate(" + main_width*-1 + ", " + main_y1(d.Anz) + ")").attr("x2", main_width + main_x(d.Uhrzeit));
                    //focus.select(".y1").attr("transform", "translate(0, " + main_y1(d.Anz) + ")").attr("x1", main_x(d.Uhrzeit));
                   }
                 
                
                    
                    
                function mouseclicker(){
                    $("#container2").html("");
                    var week=parseInt(Math.round(main_x.invert(d3.mouse(this)[0])));
                    window.week=week;
                    //d3.select("#container2").append("p").text("t="+week+"\t"+data[week].id_them);
                    
                    
                    window.id_them=data[week].id_them;
                    window.id_us=data[week].id_us;
                    var width=500, height=610;
                    
               
                    var force = d3.layout.force()
                    .charge(-120)
                    .linkDistance(30)
                    .size([width, height]);
                    
                    var svg2 = d3.select("#container2").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("pointer-events","all")
                    .append('svg:g')
                    .call(d3.behavior.zoom().on("zoom", redraw))
                    .append('svg:g');
                    
                    svg2.append('svg:rect')
                    .attr('width', width)
                    .attr('height', height)
                    .attr('fill', 'white');
                    
                    function redraw() {
                    svg2.attr("transform",
                              "translate(" + d3.event.translate + ")"
                              + " scale(" + d3.event.scale + ")");
                    }

                    
                    
                    d3.json("network_retrieval?date="+week, function(error, graph) {
                            force
                            .nodes(graph.nodes)
                            .links(graph.links)
                            .start();
                            
                            
                            var employees_id=[];
                            d3.csv("employees_id.csv",function(data){
                                   employees_id=data
                                   
                                   
                            function node_adder(nodes){
                                   for (var i=0; i < nodes.length; i++) {
                                        var index=findIndexByKeyValue(graph.nodes,"id",i)
                                        if(index!=null){
                                            graph.nodes[index].name=employees_id[i].V2
                                            }
                                        }
                                   }
                                   
                            node_adder(employees_id);


                                
                            var color = d3.scale.linear()
                            .domain([0, 1])
                            .range(["red", "black"]);
                            
                            
                         
                            
                            var link = svg2.selectAll("line.link")
                            .data(graph.links)
                            .enter().append("svg:line")
                            .attr("class", "link");
                         
                            
                            var linkedByIndex = {};
                            graph.links.forEach(function(d) {
                                          linkedByIndex[d.source.id + "," + d.target.id] = 1;
                                          });
                            
                            
                            
                            function isConnected(a, b) {
                            return linkedByIndex[a + "," + b] || linkedByIndex[b + "," + a];
                            }
                            
                            window.pink = [];
                            window.baby_blue=[];
                            graph.nodes.forEach(function(d){
                                                if(isConnected(d.id,window.id_them))
                                                window.pink.push(d.id)
                                                
                                                if(isConnected(d.id,window.id_us))
                                                window.baby_blue.push(d.id)
                                                })
                        
                            
                            var node = svg2.selectAll("g.node")
                            .data(graph.nodes)
                            .enter().append("svg:g")
                            .attr("class", "node")
                            .call(force.drag);
                            
                            
                            node.append("svg:circle")
                            .attr("class", "node")
                                   .attr("r", function(d) {return 1.5*Math.sqrt(d.degree+1)})
                            .style("fill", function(d) { if(d.id==window.id_them) return "red"; else if (isConnected(d.id,window.id_them)) return "pink"; else if (d.id==window.id_us) return "blue";  else if (isConnected(d.id,window.id_us)) return "lightblue"; else
                                   return "black"; });
                            
                            
                            node.append("svg:text")
                            .attr("class", "nodetext")
                            .attr("dx", 12)
                            .attr("dy", ".35em")
                            .text(function(d) { return d.name});

                            
                            force.on("tick", function() {
                                     link.attr("x1", function(d) { return d.source.x; })
                                     .attr("y1", function(d) { return d.source.y; })
                                     .attr("x2", function(d) { return d.target.x; })
                                     .attr("y2", function(d) { return d.target.y; });
                                     
                                     node.attr("transform", function(d) {
                                                 return 'translate(' + [d.x, d.y] + ')';
                                                 });
                                     });
                            
                                   });
                            });

                }
                    
            });
                function brush() {
                    main_x.domain(brush.empty() ? mini_x.domain() : brush.extent());
                    main.select(".line0").attr("d", main_line0);
                    main.select(".line1").attr("d", main_line1);
                    main.select(".x.axis").call(main_xAxis);
                }
            }
            
            
            function contains(a, obj) {
                for (var i = 0; i < a.length; i++) {
                    if (a[i] === obj) {
                        return true;
                    }
                }
                return false;
            }
            
            //find the index of value for a given key
            function findIndexByKeyValue(obj, key, value){
                for (var i = 0; i < obj.length; i++) {
                    if (obj[i][key] == value) {
                        return i;
                    }
                }
                return null;
            }
            
            function graph_load(u,t,w){
                $("#container2").html("");
                var week=w
                
                var id_them=u;
                var id_us=t;
                var width=500, height=610;
                var color = d3.scale.category20();
                
                
                
                var width=500, height=610;
                
                
                var force = d3.layout.force()
                .charge(-120)
                .linkDistance(30)
                .size([width, height]);
                
                var svg2 = d3.select("#container2").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("pointer-events","all")
                .append('svg:g')
                .call(d3.behavior.zoom().on("zoom", redraw))
                .append('svg:g');
                
                svg2.append('svg:rect')
                .attr('width', width)
                .attr('height', height)
                .attr('fill', 'white');
                
                function redraw() {
                    svg2.attr("transform",
                              "translate(" + d3.event.translate + ")"
                              + " scale(" + d3.event.scale + ")");
                }
                
                
                
                d3.json("network_retrieval?date="+week, function(error, graph) {
                        force
                        .nodes(graph.nodes)
                        .links(graph.links)
                        .start();
                        
                        var employees_id=[];
                        d3.csv("employees_id.csv",function(data){
                               employees_id=data
                              
                  
                               
                        //adds the name to the graph.nodes
                        function node_adder(nodes){
                               for (var i=0; i < nodes.length; i++) {
                                    var index=findIndexByKeyValue(graph.nodes,"id",i)
                                    if(index!=null){
                                        graph.nodes[index].name=employees_id[i].V2
                                    }
                               }
                        }
                               
                        node_adder(employees_id);
                    
                               var max=d3.max(graph.nodes, function(d){return d.eigcen;})
                        
                        console.log(max);
                        var color = d3.scale.linear()
                        .domain([0, max])
                        .range(["red","violet"]);
                        
                        var link = svg2.selectAll("line.link")
                        .data(graph.links)
                        .enter().append("svg:line")
                        .attr("class", "link");
                        /*.style("stroke-width", function(d) { return Math.sqrt(d.value); 
                         .attr("x1", function(d) { return d.source.x; })
                         .attr("y1", function(d) { return d.source.y; })
                         .attr("x2", function(d) { return d.target.x; })
                         .attr("y2", function(d) { return d.target.y; });
                         */
                        
                        
                        var node = svg2.selectAll("g.node")
                        .data(graph.nodes)
                        .enter().append("svg:g")
                        .attr("class", "node")
                        .call(force.drag);
                        
                        
                        node.append("svg:circle")
                        .attr("class", "node")
                               .attr("r", function(d){return 1.5*Math.sqrt(d.degree+1)})
                               //.attr("r",3)
                        .style("fill", function(d) { if(d.id==window.id_them) return "red";  else if (d.id==window.id_us) return "blue"; else if (contains(window.pink,d.id)) return "pink";  else if (contains(window.baby_blue,d.id)) return "lightblue"; else
                               return "black"; })
                         //.style("fill", function(d,i){return color(d.eigcen);});
                        
                        node.append("svg:text")
                        .attr("class", "nodetext")
                        .attr("dx", 12)
                        .attr("dy", ".35em")
                        .text(function(d) { return d.name });
                        
                        
                        /*
                         .attr("cx", function(d) { return d.x; })
                         .attr("cy", function(d) { return d.y; })
                         .attr("r", 5)
                        
                         .on("mouseover", function(d){
                         node.append("text")
                         .attr("dx", 12)
                         .attr("dy", ".35em")
                         .text(function(d) { return d.name });
                         
                         
                         })
                         .call(force.drag);*/
                        
                        /*
                         var gnodes = svg2.selectAll('g.node')
                         .data(graph.nodes)
                         .enter()
                         .append('g')
                         .classed('gnode', true);
                         
                         // Add one circle in each group
                         var node = gnodes.append("circle")
                         .attr("class", "node")
                         .attr("r", 5)
                         .style("fill", function(d,i) { if(i==window.id_them) return "red"; else if (i==window.id_us) return "blue"; else
                         return "black"; })
                         .call(force.drag);
                         
                         // Append the labels to each group
                         var labels = gnodes.append("text")
                         .attr("class","nodetext")
                         .attr("x", 10)
                         .attr("dy", ".31em")
                         .text(function(d) { return d.id; });
                         
                         */
                        force.on("tick", function() {
                                 link.attr("x1", function(d) { return d.source.x; })
                                 .attr("y1", function(d) { return d.source.y; })
                                 .attr("x2", function(d) { return d.target.x; })
                                 .attr("y2", function(d) { return d.target.y; });
                                 
                                 /*node.attr("cx", function(d) { return d.x; })
                                  .attr("cy", function(d) { return d.y; });*/
                                 
                                 node.attr("transform", function(d) {
                                           return 'translate(' + [d.x, d.y] + ')';
                                           });
                                 });
                        
                        
                        });
                        
                         });
                
            }
            $("#left").bind("click", function(event) {
                            window.week-=1
                            graph_load(window.id_us,window.id_them,window.week);
                            //$("#nav").append("<center><p> t="+window.week+"</p></center>");
                                     });
            
            $("#right").bind("click", function(event) {
                             window.week+=1
                             graph_load(window.id_us,window.id_them,window.week);
                            });

           
            </script>

</body>
</html>